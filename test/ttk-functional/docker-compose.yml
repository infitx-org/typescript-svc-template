version: "3.7"

services:
  example_users_api_service:
    image: typescript-svc-template:local
    build:
     context: ../..
     target: builder
    ports:
      - "8000:8000"
    command:
      - sh
      - -c
      - "npm start"
    healthcheck:
      test: ["CMD-SHELL", "nc localhost 8000"]
      interval: 5s
      timeout: 10s
      retries: 3
  mojaloop-testing-toolkit:
    image: mojaloop/ml-testing-toolkit:v14.0.2
    volumes:
      - "./spec_files:/opt/mojaloop-testing-toolkit/spec_files"
      - "./secrets:/opt/mojaloop-testing-toolkit/secrets"
    ports:
      - "5000:5000"
      - "5050:5050"
    command:
      - sh
      - -c
      - "npm start"
    healthcheck:
      test: ["CMD-SHELL", "nc localhost 5000"]
      interval: 5s
      timeout: 10s
      retries: 3

  mojaloop-testing-toolkit-ui:
    image: mojaloop/ml-testing-toolkit-ui:v13.5.5
    ports:
      - "6060:6060"
    environment:
      - API_BASE_URL=http://localhost:5050
      - AUTH_ENABLED=FALSE
    command:
      - sh
      - /usr/share/nginx/start.sh

  ttk-functional-tests:
    image: mojaloop/ml-testing-toolkit:v14.0.2
    volumes:
      - "./collections:/opt/mojaloop-testing-toolkit/collections"
      - "./environments:/opt/mojaloop-testing-toolkit/environments"
    depends_on:
      mojaloop-testing-toolkit:
        condition: service_healthy
      example_users_api_service:
        condition: service_healthy

    command:
      - sh
      - -c
      - "npm run cli -- -u http://mojaloop-testing-toolkit:5050 -i collections -e environments/default-env.json"

networks:
  default:
    name: test-net


